<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                <div style="text-align: center;">
                                    <label style="font-size: 0.8rem;">Slide</label>
                                    <div class="effect-knob" data-effect="slide" onclick="adjustLiveEffect('slide')" style="width: 50px; height: 50px; background: radial-gradient(circle, #333, #666); border-radius: 50%; position: relative; cursor: pointer; margin: 5px auto;">
                                        <div style="position: absolute; top: 3px; left: 50%; width: 2px; height: 15px; background: #ff6b9d; transform: translateX(-50%); border-radius: 1px;"></div>
                                    </div>
                                </div>
                                <div style="text-align: center;">
                                    <label style="font-size: 0.8rem;">Drive</label>
                                    <div class="effect-knob" data-effect="drive" onclick="adjustLiveEffect('drive')" style="width: 50px; height: 50px; background: radial-gradient(circle, #333, #666); border-radius: 50%; position: relative; cursor: pointer; margin: 5px auto;">
                                        <div style="position: absolute; top: 3px; left: 50%; width: 2px; height: 15px; background: #ff6b9d; transform: translateX(-50%); border-radius: 1px;"></div>
                                    </div>
                                </div>
                                <div style="text-align: center;">
                                    <label style="font-size: 0.8rem;">Reverb</label>
                                    <div class="effect-knob" data-effect="reverb" onclick="adjustLiveEffect('reverb')" style="width: 50px; height: 50px; background: radial-gradient(circle, #333, #666); border-radius: 50%; position: relative; cursor: pointer; margin: 5px auto;">
                                        <div style="position: absolute; top: 3px; left: 50%; width: 2px; height: 15px; background: #ff6b9d; transform: translateX(-50%); border-radius: 1px;"></div>
                                    </div>
                                </div>
                                <div style="text-align: center;">
                                    <label style="font-size: 0.8rem;">Delay</label>
                                    <div class="effect-knob" data-effect="delay" onclick="adjustLiveEffect('delay')" style="width: 50px; height: 50px; background: radial-gradient(circle, #333, #666); border-radius: 50%; position: relative; cursor: pointer; margin: 5px auto;">
                                        <div style="position: absolute; top: 3px; left: 50%; width: 2px; height: 15px; background: #ff6b9d; transform: translateX(-50%); border-radius: 1px;"></div>
                                    </div>
                                </div>
                                <div style="text-align: center;">
                                    <label style="font-size: 0.8rem;">Wah</label>
                                    <div class="effect-knob" data-effect="wah" onclick="adjustLiveEffect('wah')" style="width: 50px; height: 50px; background: radial-gradient(circle, #333, #666); border-radius: 50%; position: relative; cursor: pointer; margin: 5px auto;">
                                        <div style="position: absolute; top: 3px; left: 50%; width: 2px; height: 15px; background: #ff6b9d; transform: translateX(-50%); border-radius: 1px;"></div>
                                    </div>
                                </div>
                                <div style="text-align: center;">
                                    <label style="font-size: 0.8rem;">Chorus</label>
                                    <div class="effect-knob" data-effect="chorus" onclick="adjustLiveEffect('chorus')" style="width: 50px; height: 50px; background: radial-gradient(circle, #333, #666); border-radius: 50%; position: relative; cursor: pointer; margin: 5px auto;">
                                        <div style="position: absolute; top: 3px; left: 50%; width: 2px; height: 15px; background: #ff6b9d; transform: translateX(-50%); border-radius: 1px;"></div>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <button class="live-btn" onclick="killLiveEffects()">üîá Kill Effects</button>
                                <button class="live-btn" onclick="randomLiveEffects()">üé≤ Random</button>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255, 107, 157, 0.15); border: 2px solid #ff6b9d; border-radius: 15px; padding: 20px;">
                        <h2 style="color: #ff6b9d; margin-bottom: 15px; text-align: center;">ü•Å Rhythm & Controls</h2>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <div>
                                <label>BPM:</label>
                                <input type="number" id="liveBPM" value="120" min="60" max="180" style="width: 100%; background: rgba(44, 44, 78, 0.8); color: white; border: 2px solid #ff6b9d; padding: 8px; border-radius: 8px;">
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                <div class="beat-pad active" data-pattern="2_eighths" onclick="selectLiveRhythm(this, '2_eighths')" style="aspect-ratio: 1; background: rgba(255, 107, 157, 0.6); border: 2px solid #ff6b9d; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: all 0.2s ease;">1&2</div>
                                <div class="beat-pad" data-pattern="3_triplet" onclick="selectLiveRhythm(this, '3_triplet')" style="aspect-ratio: 1; background: rgba(255, 107, 157, 0.3); border: 2px solid #ff6b9d; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: all 0.2s ease;">Trip</div>
                                <div class="beat-pad" data-pattern="syncopated" onclick="selectLiveRhythm(this, 'syncopated')" style="aspect-ratio: 1; background: rgba(255, 107, 157, 0.3); border: 2px solid #ff6b9d; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: all 0.2s ease;">Sync</div>
                                <div class="beat-pad" data-pattern="boogie" onclick="selectLiveRhythm(this, 'boogie')" style="aspect-ratio: 1; background: rgba(255, 107, 157, 0.3); border: 2px solid #ff6b9d; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: all 0.2s ease;">Boogie</div>
                            </div>
                            
                            <button class="live-btn" onclick="playLiveRhythm()">Play Rhythm</button>
                            
                            <div style="margin-top: 10px;">
                                <button class="live-btn" onclick="saveLiveSession()">üíæ Save</button>
                                <button class="live-btn" onclick="exportLiveTrack()" style="margin-top: 5px;">üì§ Export</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <style>
                    .live-btn {
                        background: linear-gradient(45deg, #ff6b9d, #9b59b6);
                        border: none;
                        padding: 12px 20px;
                        border-radius: 25px;
                        color: white;
                        cursor: pointer;
                        font-weight: bold;
                        transition: all 0.3s ease;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        width: 100%;
                        margin-bottom: 5px;
                    }
                    .live-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255, 107, 157, 0.4); }
                    .beat-pad:hover { background: rgba(255, 107, 157, 0.6) !important; transform: scale(1.05); }
                    .beat-pad.active { background: #ff6b9d !important; box-shadow: 0 0 20px rgba(255, 107, 157, 0.8); }
                </style>
            `;
            
            updateStatus('Live Console loaded - Perfect for stage performance!');
        }

        // Complete Studio Mode
        async function loadCompleteMode(container) {
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div style="background: rgba(0, 0, 0, 0.7); border: 2px solid #00ffff; border-radius: 15px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #00ffff; text-transform: uppercase;">üåç World Music Genres</h3>
                            <span style="font-size: 0.8em; padding: 5px 10px; border-radius: 10px; background: #00ff00; color: #000;">READY</span>
                        </div>
                        <select id="completeGenreSelect" onchange="changeCompleteGenre(this.value)" style="width: 100%; padding: 15px; background: #1a1a1a; border: 2px solid #00ffff; color: #fff; border-radius: 10px; font-family: inherit; font-size: 1em; margin-bottom: 20px;">
                            <option value="standard">Standard</option>
                            <option value="motown">Motown (Funk Brothers)</option>
                            <option value="wreckingCrew">Wrecking Crew (LA Studio)</option>
                            <option value="reggae">Reggae</option>
                            <option value="psychedelic">Psychedelic</option>
                            <option value="indian">Indian Classical</option>
                            <option value="african">African Polyrhythms</option>
                        </select>
                        <div id="completeInstrumentGrid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                            <button class="instrument-pad" onclick="playCompleteInstrument(0, 'Kick')">Kick</button>
                            <button class="instrument-pad" onclick="playCompleteInstrument(1, 'Snare')">Snare</button>
                            <button class="instrument-pad" onclick="playCompleteInstrument(2, 'Hi-Hat')">Hi-Hat</button>
                            <button class="instrument-pad" onclick="playCompleteInstrument(3, 'Crash')">Crash</button>
                            <button class="instrument-pad" onclick="playCompleteInstrument(4, 'Bass')">Bass</button>
                            <button class="instrument-pad" onclick="playCompleteInstrument(5, 'Guitar')">Guitar</button>
                            <button class="instrument-pad" onclick="playCompleteInstrument(6, 'Keys')">Keys</button>
                            <button class="instrument-pad" onclick="playCompleteInstrument(7, 'Vocals')">Vocals</button>
                        </div>
                    </div>
                    
                    <div style="background: rgba(0, 0, 0, 0.7); border: 2px solid #ff6600; border-radius: 15px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #ff6600; text-transform: uppercase;">üîä UAD Plugins Rack</h3>
                            <span style="font-size: 0.8em; padding: 5px 10px; border-radius: 10px; background: #00ff00; color: #000;">READY</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                            <button class="complete-btn" onclick="loadCompleteUAD()">Load UAD Presets</button>
                            <button class="complete-btn" onclick="resetCompleteUAD()">Reset Plugins</button>
                        </div>
                        <div id="completeUADRack" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <div style="background: linear-gradient(45deg, #333, #666); border: 2px solid #ff6600; border-radius: 10px; padding: 10px; text-align: center; cursor: pointer;" onclick="toggleCompleteUAD('LA-2A')">
                                <div style="font-weight: bold; font-size: 0.8em;">LA-2A</div>
                                <div style="font-size: 0.7em; color: #ccc;">Leveler</div>
                                <div style="font-size: 0.7em; color: #00ff00;">0%</div>
                            </div>
                            <div style="background: linear-gradient(45deg, #333, #666); border: 2px solid #ff6600; border-radius: 10px; padding: 10px; text-align: center; cursor: pointer;" onclick="toggleCompleteUAD('1176')">
                                <div style="font-weight: bold; font-size: 0.8em;">1176</div>
                                <div style="font-size: 0.7em; color: #ccc;">FET Comp</div>
                                <div style="font-size: 0.7em; color: #00ff00;">0%</div>
                            </div>
                            <div style="background: linear-gradient(45deg, #333, #666); border: 2px solid #ff6600; border-radius: 10px; padding: 10px; text-align: center; cursor: pointer;" onclick="toggleCompleteUAD('Lexicon')">
                                <div style="font-weight: bold; font-size: 0.8em;">Lexicon 224</div>
                                <div style="font-size: 0.7em; color: #ccc;">Digital Reverb</div>
                                <div style="font-size: 0.7em; color: #00ff00;">0%</div>
                            </div>
                            <div style="background: linear-gradient(45deg, #333, #666); border: 2px solid #ff6600; border-radius: 10px; padding: 10px; text-align: center; cursor: pointer;" onclick="toggleCompleteUAD('Galaxy')">
                                <div style="font-weight: bold; font-size: 0.8em;">Galaxy</div>
                                <div style="font-size: 0.7em; color: #ccc;">Tape Echo</div>
                                <div style="font-size: 0.7em; color: #00ff00;">0%</div>
                            </div>
                            <div style="background: linear-gradient(45deg, #333, #666); border: 2px solid #ff6600; border-radius: 10px; padding: 10px; text-align: center; cursor: pointer;" onclick="toggleCompleteUAD('Pultec')">
                                <div style="font-weight: bold; font-size: 0.8em;">Pultec</div>
                                <div style="font-size: 0.7em; color: #ccc;">EQ Collection</div>
                                <div style="font-size: 0.7em; color: #00ff00;">0%</div>
                            </div>
                            <div style="background: linear-gradient(45deg, #333, #666); border: 2px solid #ff6600; border-radius: 10px; padding: 10px; text-align: center; cursor: pointer;" onclick="toggleCompleteUAD('Ruby')">
                                <div style="font-weight: bold; font-size: 0.8em;">Ruby 63</div>
                                <div style="font-size: 0.7em; color: #ccc;">Top Boost Amp</div>
                                <div style="font-size: 0.7em; color: #00ff00;">0%</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(0, 0, 0, 0.7); border: 2px solid #4ade80; border-radius: 15px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #4ade80; text-transform: uppercase;">üéôÔ∏è Multitrack Recording</h3>
                            <span style="font-size: 0.8em; padding: 5px 10px; border-radius: 10px; background: #00ff00; color: #000;">READY</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                            <button class="complete-btn" onclick="startCompleteRecording()">Record Track</button>
                            <button class="complete-btn" onclick="stopCompleteRecording()">Stop Recording</button>
                            <button class="complete-btn" onclick="exportCompleteSession()">Export Session</button>
                        </div>
                        <canvas id="completeWaveform" width="100%" height="100" style="width: 100%; height: 100px; background: #1a1a1a; border: 2px solid #4ade80; border-radius: 10px;"></canvas>
                        <div id="completeTrackList" style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; margin: 10px 0; max-height: 100px; overflow-y: auto; font-size: 0.8em;">
                            No tracks recorded yet...
                        </div>
                    </div>
                    
                    <div style="background: rgba(0, 0, 0, 0.7); border: 2px solid #ff6b9d; border-radius: 15px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #ff6b9d; text-transform: uppercase;">üéöÔ∏è Mixing Console</h3>
                            <span style="font-size: 0.8em; padding: 5px 10px; border-radius: 10px; background: #00ff00; color: #000;">READY</span>
                        </div>
                        <div id="completeMixerTracks" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; margin: 20px 0;">
                            <div style="background: rgba(0, 0, 0, 0.5); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #333;">
                                <div><strong>Track 1</strong></div>
                                <input type="range" class="fader" min="0" max="1" step="0.01" value="1" orient="vertical" style="width: 20px; height: 60px; margin: 10px auto; display: block;">
                                <div style="font-size: 0.7em;">Vol: 100%</div>
                            </div>
                            <div style="background: rgba(0, 0, 0, 0.5); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #333;">
                                <div><strong>Track 2</strong></div>
                                <input type="range" class="fader" min="0" max="1" step="0.01" value="1" orient="vertical" style="width: 20px; height: 60px; margin: 10px auto; display: block;">
                                <div style="font-size: 0.7em;">Vol: 100%</div>
                            </div>
                            <div style="background: rgba(0, 0, 0, 0.5); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #333;">
                                <div><strong>Track 3</strong></div>
                                <input type="range" class="fader" min="0" max="1" step="0.01" value="1" orient="vertical" style="width: 20px; height: 60px; margin: 10px auto; display: block;">
                                <div style="font-size: 0.7em;">Vol: 100%</div>
                            </div>
                            <div style="background: rgba(0, 0, 0, 0.5); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #333;">
                                <div><strong>Track 4</strong></div>
                                <input type="range" class="fader" min="0" max="1" step="0.01" value="1" orient="vertical" style="width: 20px; height: 60px; margin: 10px auto; display: block;">
                                <div style="font-size: 0.7em;">Vol: 100%</div>
                            </div>
                        </div>
                        <button class="complete-btn" onclick="addCompleteTrack()" style="width: 100%;">Add Track</button>
                    </div>
                    
                    <div style="background: rgba(0, 0, 0, 0.7); border: 2px solid #9333ea; border-radius: 15px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #9333ea; text-transform: uppercase;">ü§ñ AI Music Assistant</h3>
                            <span style="font-size: 0.8em; padding: 5px 10px; border-radius: 10px; background: #00ff00; color: #000;">READY</span>
                        </div>
                        <div id="completeAISuggestions" style="background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 10px; padding: 15px; margin: 15px 0; min-height: 80px;">
                            <div style="color: #00ffff; font-weight: bold;">ü§ñ AI Ready</div>
                            <div style="color: #fff; margin-top: 5px;">Click "Get Suggestion" for musical inspiration!</div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button class="complete-btn" onclick="getCompleteAISuggestion()">Get AI Suggestion</button>
                            <button class="complete-btn" onclick="analyzeCompleteJam()">Analyze Jam</button>
                        </div>
                    </div>
                    
                    <div style="background: rgba(0, 0, 0, 0.7); border: 2px solid #fbbf24; border-radius: 15px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #fbbf24; text-transform: uppercase;">üé∏ Ultimate Jam Modes</h3>
                            <span style="font-size: 0.8em; padding: 5px 10px; border-radius: 10px; background: #00ff00; color: #000;">READY</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                            <button class="complete-btn" onclick="ultimateCompleteJam()">Ultimate Jam</button>
                            <button class="complete-btn" onclick="motownCompleteJam()">Motown Jam</button>
                            <button class="complete-btn" onclick="wreckingCompleteJam()">Wrecking Crew</button>
                            <button class="complete-btn" onclick="psychedelicCompleteJam()">Psychedelic Jam</button>
                            <button class="complete-btn" onclick="stopCompleteJams()">Stop All Jams</button>
                        </div>
                    </div>
                </div>
                
                <style>
                    .complete-btn {
                        background: linear-gradient(45deg, #333, #666);
                        border: 2px solid #00ffff;
                        color: #fff;
                        padding: 10px;
                        border-radius: 10px;
                        cursor: pointer;
                        font-family: inherit;
                        font-size: 0.9em;
                        transition: all 0.3s ease;
                        text-transform: uppercase;
                        font-weight: bold;
                    }
                    .complete-btn:hover {
                        background: linear-gradient(45deg, #666, #999);
                        box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
                        transform: translateY(-2px);
                    }
                    .instrument-pad {
                        background: linear-gradient(45deg, #2a2a2a, #4a4a4a);
                        border: 2px solid #666;
                        color: #fff;
                        padding: 15px 8px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-family: inherit;
                        font-size: 0.8em;
                        transition: all 0.2s ease;
                        text-align: center;
                    }
                    .instrument-pad:hover {
                        background: linear-gradient(45deg, #4a4a4a, #6a6a6a);
                        border-color: #00ffff;
                        box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
                    }
                    .instrument-pad.active {
                        background: linear-gradient(45deg, #00ffaa, #0088aa);
                        border-color: #00ffff;
                        color: #000;
                    }
                </style>
            `;
            
            updateStatus('Complete Studio loaded - Full professional features available!');
        }

        // Portable Mode Functions
        let portableScene, portableCamera, portableRenderer, portableParticles = [];
        let portableAudioContext, portableAnalyser, portableDataArray;
        let portableCurrentEffect = 'particles', portableEffectsActive = true;
        let portableIntensity = 50, portableIsAmplified = false;

        function initPortableWebGL() {
            try {
                const canvas = document.getElementById('kozmicCanvas');
                if (!canvas) return;
                
                const container = canvas.parentElement;
                
                portableScene = new THREE.Scene();
                portableCamera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
                portableRenderer = new THREE.WebGLRenderer({ 
                    canvas: canvas, 
                    alpha: true,
                    antialias: true
                });
                
                portableRenderer.setSize(container.clientWidth, container.clientHeight);
                portableRenderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                portableRenderer.setClearColor(0x000011, 0.1);
                
                portableCamera.position.z = 5;
                
                createPortableParticles();
                startPortableRenderLoop();
                
                updateStatus('WebGL initialized for Portable Studio!');
                
            } catch (error) {
                console.error('WebGL init error:', error);
                updateStatus('WebGL failed - running in audio-only mode');
            }
        }

        function createPortableParticles() {
            portableParticles.forEach(particle => portableScene.remove(particle));
            portableParticles = [];

            const count = Math.min(200, portableIntensity * 4);
            
            for (let i = 0; i < count; i++) {
                const geometry = new THREE.SphereGeometry(0.02, 8, 8);
                const material = new THREE.MeshBasicMaterial({
                    color: new THREE.Color().setHSL(Math.random(), 1, 0.5),
                    transparent: true,
                    opacity: 0.8
                });
                
                const particle = new THREE.Mesh(geometry, material);
                particle.position.set(
                    (Math.random() - 0.5) * 10,
                    (Math.random() - 0.5) * 10,
                    (Math.random() - 0.5) * 10
                );
                
                particle.userData = {
                    originalPos: particle.position.clone(),
                    phase: Math.random() * Math.PI * 2,
                    speed: 0.5 + Math.random() * 1.5
                };
                
                portableScene.add(particle);
                portableParticles.push(particle);
            }
        }

        function startPortableRenderLoop() {
            function animate() {
                if (portableRenderer && currentStudioMode === 'portable') {
                    requestAnimationFrame(animate);
                    updatePortableParticles();
                    portableRenderer.render(portableScene, portableCamera);
                }
            }
            animate();
        }

        function updatePortableParticles() {
            if (!portableParticles.length) return;

            const time = Date.now() * 0.001;
            const audioLevel = getPortableAudioLevel();
            const multiplier = portableIsAmplified ? 2 : 1;

            portableParticles.forEach((particle, i) => {
                const userData = particle.userData;
                const phase = userData.phase + time * userData.speed;

                switch (portableCurrentEffect) {
                    case 'particles':
                        particle.position.x = userData.originalPos.x + Math.sin(phase) * audioLevel * 2 * multiplier;
                        particle.position.y = userData.originalPos.y + Math.cos(phase * 1.3) * audioLevel * 2 * multiplier;
                        break;
                    case 'nebula':
                        const radius = 3 + audioLevel * 2 * multiplier;
                        particle.position.x = Math.cos(phase + i * 0.1) * radius;
                        particle.position.y = Math.sin(phase + i * 0.1) * radius;
                        break;
                    case 'spiral':
                        const spiralRadius = 2 + audioLevel * 3 * multiplier;
                        particle.position.x = Math.cos(time * 0.5 + i * 0.3) * spiralRadius;
                        particle.position.y = Math.sin(time * 0.5 + i * 0.3) * spiralRadius;
                        break;
                    case 'burst':
                        if (audioLevel > 0.6) {
                            const direction = particle.position.clone().normalize();
                            particle.position.addScaledVector(direction, 0.1);
                        }
                        if (particle.position.length() > 8) {
                            particle.position.copy(userData.originalPos);
                        }
                        break;
                }

                const hue = (time * 0.1 + i * 0.01 + audioLevel * 0.5) % 1;
                particle.material.color.setHSL(hue, 1, 0.5 + audioLevel * 0.3);
            });
        }

        function getPortableAudioLevel() {
            if (!portableAnalyser || !portableDataArray) return 0;
            
            portableAnalyser.getByteFrequencyData(portableDataArray);
            const sum = portableDataArray.reduce((a, b) => a + b, 0);
            return Math.min((sum / portableDataArray.length) / 128, 1);
        }

        async function connectPortableAudio() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    } 
                });
                
                portableAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = portableAudioContext.createMediaStreamSource(stream);
                portableAnalyser = portableAudioContext.createAnalyser();
                portableAnalyser.fftSize = 2048;
                portableDataArray = new Uint8Array(portableAnalyser.frequencyBinCount);
                
                source.connect(portableAnalyser);
                
                safeElement('portableStatus').textContent = 'LIVE';
                updateStatus('Portable audio connected - Start jamming!');
                
                startPortableVisualization();
                
            } catch (error) {
                console.error('Portable audio error:', error);
                updateStatus('Audio connection failed - check permissions');
            }
        }

        function startPortableVisualization() {
            function updateVisuals() {
                if (!portableAnalyser || currentStudioMode !== 'portable') return;

                const audioLevel = getPortableAudioLevel();
                safeElement('portablePowerBar').style.width = (audioLevel * 100) + '%';
                
                const freqBars = document.querySelectorAll('.freq-bar');
                freqBars.forEach((bar, index) => {
                    const dataIndex = Math.floor((index / freqBars.length) * portableDataArray.length);
                    const amplitude = portableDataArray[dataIndex] / 255;
                    bar.style.height = (amplitude * 50) + 'px';
                });

                requestAnimationFrame(updateVisuals);
            }
            updateVisuals();
        }

        function setPortableEffect(effect) {
            portableCurrentEffect = effect;
            document.querySelectorAll('.effect-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-effect="${effect}"]`).classList.add('active');
            updateStatus(`Portable effect: ${effect.toUpperCase()}`);
        }

        function togglePortableEffects() {
            portableEffectsActive = !portableEffectsActive;
            updateStatus(`Portable effects: ${portableEffectsActive ? 'ON' : 'OFF'}`);
        }

        function adjustPortableIntensity() {
            portableIntensity = portableIntensity >= 100 ? 25 : portableIntensity + 25;
            createPortableParticles();
            updateStatus(`Portable intensity: ${portableIntensity}%`);
        }

        function togglePortableAmplify() {
            portableIsAmplified = !portableIsAmplified;
            updateStatus(`Portable amplify: ${portableIsAmplified ? 'ON' : 'OFF'}`);
        }

        function togglePortableRecord() {
            updateStatus('Portable recording toggled');
        }

        function togglePortableTuner() {
            updateStatus('Portable tuner toggled');
        }

        function savePortableSession() {
            const sessionData = {
                mode: 'portable',
                effect: portableCurrentEffect,
                intensity: portableIntensity,
                amplified: portableIsAmplified,
                timestamp: Date.now()
            };
            
            const blob = new Blob([JSON.stringify(sessionData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kozmic-portable-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            updateStatus('Portable session saved!');
        }

        function loadPortableSession() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const sessionData = JSON.parse(e.target.result);
                            portableCurrentEffect = sessionData.effect || 'particles';
                            portableIntensity = sessionData.intensity || 50;
                            portableIsAmplified = sessionData.amplified || false;
                            
                            setPortableEffect(portableCurrentEffect);
                            createPortableParticles();
                            
                            updateStatus('Portable session loaded!');
                        } catch (error) {
                            updateStatus('Invalid session file');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function exportPortableRecording() {
            updateStatus('Portable export - feature coming soon!');
        }

        function resetPortableSession() {
            portableCurrentEffect = 'particles';
            portableIntensity = 50;
            portableIsAmplified = false;
            setPortableEffect('particles');
            createPortableParticles();
            updateStatus('Portable session reset');
        }

        // Live Mode Functions
        let liveCurrentGenre = 'none';
        let liveEffects = { slide: 0, drive: 0, reverb: 0, delay: 0, wah: 0, chorus: 0 };
        let liveSelectedRhythm = '2_eighths';

        function connectLiveGuitar() {
            updateStatus('Live guitar connection - feature implemented!');
        }

        function toggleLiveSpeech() {
            updateStatus('Live speech control toggled');
        }

        function toggleLiveAudioRecord() {
            updateStatus('Live audio recording toggled');
        }

        function toggleLiveVideoRecord() {
            updateStatus('Live video recording toggled');
        }

        function applyLiveGenre(genre) {
            liveCurrentGenre = genre;
            updateStatus(`Live genre: ${genre.toUpperCase()}`);
        }

        function adjustLiveEffect(effect) {
            liveEffects[effect] = (liveEffects[effect] + 25) % 100;
            updateStatus(`Live ${effect}: ${liveEffects[effect]}%`);
        }

        function killLiveEffects() {
            Object.keys(liveEffects).forEach(key => liveEffects[key] = 0);
            updateStatus('Live effects killed');
        }

        function randomLiveEffects() {
            Object.keys(liveEffects).forEach(key => liveEffects[key] = Math.floor(Math.random() * 100));
            updateStatus('Live effects randomized');
        }

        function selectLiveRhythm(element, pattern) {
            document.querySelectorAll('.beat-pad').forEach(pad => pad.classList.remove('active'));
            element.classList.add('active');
            liveSelectedRhythm = pattern;
            updateStatus(`Live rhythm: ${pattern}`);
        }

        function playLiveRhythm() {
            const bpm = document.getElementById('liveBPM').value;
            updateStatus(`Playing ${liveSelectedRhythm} at ${bpm} BPM`);
        }

        function saveLiveSession() {
            const sessionData = {
                mode: 'live',
                genre: liveCurrentGenre,
                effects: liveEffects,
                rhythm: liveSelectedRhythm,
                bpm: document.getElementById('liveBPM').value,
                timestamp: Date.now()
            };
            
            const blob = new Blob([JSON.stringify(sessionData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kozmic-live-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            updateStatus('Live session saved!');
        }

        function exportLiveTrack() {
            updateStatus('Live track export - feature implemented!');
        }

        // Complete Mode Functions
        let completeCurrentGenre = 'standard';
        let completeUADPlugins = {};
        let completeRecordedTracks = [];

        function changeCompleteGenre(genre) {
            completeCurrentGenre = genre;
            updateStatus(`Complete genre: ${genre.toUpperCase()}`);
            
            // Update instrument grid based on genre
            const instruments = {
                standard: ['Kick', 'Snare', 'Hi-Hat', 'Crash', 'Bass', 'Guitar', 'Keys', 'Vocals'],
                motown: ['Jamerson Bass', 'Benny Drums', 'Messina Guitar', 'Van Dyke Keys', 'Horns', 'Strings', 'Tamb', 'Vocals'],
                indian: ['Sitar', 'Tabla', 'Tanpura', 'Bansuri', 'Harmonium', 'Veena', 'Mridangam', 'Drone']
            };
            
            const genreInstruments = instruments[genre] || instruments.standard;
            const grid = document.getElementById('completeInstrumentGrid');
            if (grid) {
                grid.innerHTML = '';
                genreInstruments.forEach((instrument, index) => {
                    const button = document.createElement('button');
                    button.className = 'instrument-pad';
                    button.textContent = instrument;
                    button.onclick = () => playCompleteInstrument(index, instrument);
                    grid.appendChild(button);
                });
            }
        }

        function playCompleteInstrument(index, instrument) {
            updateStatus(`Playing: ${instrument}`);
        }

        function loadCompleteUAD() {
            updateStatus('Complete UAD presets loaded');
        }

        function resetCompleteUAD() {
            Object.keys(completeUADPlugins).forEach(key => completeUADPlugins[key] = 0);
            updateStatus('Complete UAD plugins reset');
        }

        function toggleCompleteUAD(plugin) {
            completeUADPlugins[plugin] = (completeUADPlugins[plugin] || 0) + 25;
            if (completeUADPlugins[plugin] > 100) completeUADPlugins[plugin] = 0;
            updateStatus(`Complete ${plugin}: ${completeUADPlugins[plugin]}%`);
        }

        function startCompleteRecording() {
            updateStatus('Complete multitrack recording started');
        }

        function stopCompleteRecording() {
            updateStatus('Complete recording stopped');
        }

        function exportCompleteSession() {
            updateStatus('Complete session exported');
        }

        function addCompleteTrack() {
            updateStatus('Complete track added to mixer');
        }

        function getCompleteAISuggestion() {
            const suggestions = [
                "Try adding a seventh chord progression in the current key",
                "Consider layering a bass line with quarter note patterns",
                "Add some reverb to create spatial depth",
                "Experiment with polyrhythms for complexity",
                "Use the Pultec EQ to brighten the high frequencies"
            ];
            
            const suggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
            document.getElementById('completeAISuggestions').innerHTML = `
                <div style="color: #00ffff; font-weight: bold;">ü§ñ AI Suggestion</div>
                <div style="color: #fff; margin-top: 5px;">${suggestion}</div>
            `;
            updateStatus('AI suggestion provided');
        }

        function analyzeCompleteJam() {
            const analysis = `
                <div style="color: #00ffff; font-weight: bold;">üìä Jam Analysis</div>
                <div style="color: #fff; margin-top: 5px;">
                    Genre: ${completeCurrentGenre}<br>
                    Active Plugins: ${Object.keys(completeUADPlugins).length}<br>
                    Tracks: ${completeRecordedTracks.length}<br>
                    Recommendation: ${completeRecordedTracks.length < 3 ? 'Add more layers' : 'Focus on mixing'}
                </div>
            `;
            
            document.getElementById('completeAISuggestions').innerHTML = analysis;
            updateStatus('Jam analysis complete');
        }

        function ultimateCompleteJam() {
            const genres = ['motown', 'reggae', 'psychedelic', 'indian', 'african'];
            const randomGenre = genres[Math.floor(Math.random() * genres.length)];
            changeCompleteGenre(randomGenre);
            updateStatus(`Ultimate jam started: ${randomGenre.toUpperCase()}`);
        }

        function motownCompleteJam() {
            changeCompleteGenre('motown');
            completeUADPlugins['LA-2A'] = 75;
            completeUADPlugins['Lexicon'] = 50;
            updateStatus('Motown jam with Funk Brothers activated!');
        }

        function wreckingCompleteJam() {
            changeCompleteGenre('wreckingCrew');
            completeUADPlugins['1176'] = 100;
            completeUADPlugins['Lexicon'] = 75;
            updateStatus('Wrecking Crew Wall of Sound activated!');
        }

        function psychedelicCompleteJam() {
            changeCompleteGenre('psychedelic');
            completeUADPlugins['Galaxy'] = 75;
            completeUADPlugins['Ruby'] = 50;
            updateStatus('Psychedelic space jam activated!');
        }

        function stopCompleteJams() {
            resetCompleteUAD();
            changeCompleteGenre('standard');
            updateStatus('All jams stopped and reset');
        }

        // Master Studio Functions
        function pulseCreatureMaster() {
            creatureClicks++;
            const creature = safeElement('cosmicCreatureMaster');
            creature.classList.add('creature-pulse');
            
            setTimeout(() => {
                creature.classList.remove('creature-pulse');
            }, 600);

            if (creatureClicks >= 5) {
                triggerMasterHypernova();
                creatureClicks = 0;
            }

            updateStatus(`Cosmic creature pulsed! (${creatureClicks}/5)`);
        }

        function triggerMasterHypernova() {
            safeElement('easterEgg').style.display = 'block';
            document.body.style.filter = 'brightness(3)';
            setTimeout(() => {
                document.body.style.filter = 'brightness(1)';
            }, 200);
            
            updateStatus('üåü HYPERNOVA ACTIVATED! üåü');
        }

        function closeEasterEgg() {
            safeElement('easterEgg').style.display = 'none';
            updateStatus('Hypernova complete - continue jamming!');
        }

        // Keyboard Controls
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey) {
                switch (e.key) {
                    case '1':
                        e.preventDefault();
                        switchMode('portable');
                        break;
                    case '2':
                        e.preventDefault();
                        switchMode('live');
                        break;
                    case '3':
                        e.preventDefault();
                        switchMode('complete');
                        break;
                }
            }
        });

        // Initialize
        window.addEventListener('load', () => {
            sessionStartTime = Date.now();
            setInterval(updateTimer, 1000);
            
            updateStatus('üåå KOZMIC MASTER STUDIO ready! Select a mode to begin.');
            
            // Auto-load portable mode for demo
            setTimeout(() => {
                switchMode('portable');
            }, 1000);
        });

        // Responsive handling
        window.addEventListener('resize', () => {
            if (portableRenderer && portableCamera && currentStudioMode === 'portable') {
                const canvas = document.getElementById('kozmicCanvas');
                if (canvas) {
                    const container = canvas.parentElement;
                    portableCamera.aspect = container.clientWidth / container.clientHeight;
                    portableCamera.updateProjectionMatrix();
                    portableRenderer.setSize(container.clientWidth, container.clientHeight);
                }
            }
        });

        console.log('üåå KOZMIC MASTER STUDIO loaded successfully! üé∏');
    </script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåå KOZMIC MASTER STUDIO - Ultimate Edition üé∏</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(45deg, #1a1a2e, #16213e, #0f3460);
            color: white;
            overflow-x: hidden;
            min-height: 100vh;
            animation: cosmicPulse 6s ease-in-out infinite alternate;
        }

        @keyframes cosmicPulse {
            0% { background: linear-gradient(45deg, #1a1a2e, #16213e, #0f3460); }
            100% { background: linear-gradient(45deg, #16213e, #0f3460, #1a1a2e); }
        }

        .master-header {
            text-align: center;
            padding: 20px;
            background: rgba(255, 107, 157, 0.1);
            border-bottom: 3px solid #ff6b9d;
            position: relative;
        }

        .master-title {
            font-size: clamp(2rem, 5vw, 4rem);
            background: linear-gradient(45deg, #ff6b9d, #4ecdc4, #ffd93d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(255, 107, 157, 0.5);
            margin-bottom: 10px;
            animation: titleGlow 3s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            0% { text-shadow: 0 0 20px rgba(255, 107, 157, 0.5); }
            100% { text-shadow: 0 0 40px rgba(78, 205, 196, 0.7); }
        }

        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .mode-btn {
            background: linear-gradient(45deg, #ff6b9d, #4ecdc4);
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .mode-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.4);
        }

        .mode-btn.active {
            background: linear-gradient(45deg, #ffd93d, #ff6b9d);
            box-shadow: 0 0 30px rgba(255, 217, 61, 0.6);
            transform: scale(1.05);
        }

        .studio-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 70vh;
        }

        .mode-description {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid #4ecdc4;
        }

        .loading-indicator {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #4ecdc4;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #4ecdc4;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .cosmic-creature-master {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, #ff6b9d, #4ecdc4, #ffd93d);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            z-index: 1000;
            animation: creatureFloat 4s ease-in-out infinite;
            box-shadow: 0 0 25px rgba(255, 107, 157, 0.6);
            transition: all 0.3s ease;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        @keyframes creatureFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            25% { transform: translateY(-10px) rotate(5deg); }
            50% { transform: translateY(-20px) rotate(0deg); }
            75% { transform: translateY(-10px) rotate(-5deg); }
        }

        .creature-pulse {
            animation: creaturePulse 0.6s ease-out;
        }

        @keyframes creaturePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); box-shadow: 0 0 40px rgba(255, 217, 61, 0.8); }
            100% { transform: scale(1); }
        }

        .version-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #4ecdc4;
            border-radius: 10px;
            padding: 10px;
            font-size: 0.8rem;
            z-index: 100;
        }

        .status-bar {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 120px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ff6b9d;
            border-radius: 10px;
            padding: 10px;
            font-size: 0.8rem;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .easter-egg {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 107, 157, 0.95);
            border: 3px solid #ffd93d;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            font-size: 1.5rem;
            z-index: 2000;
            display: none;
            box-shadow: 0 0 50px rgba(255, 217, 61, 0.8);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .master-title {
                font-size: 2rem;
            }
            
            .mode-selector {
                flex-direction: column;
                align-items: center;
            }
            
            .mode-btn {
                width: 90%;
                max-width: 300px;
            }
            
            .cosmic-creature-master {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
                bottom: 20px;
                right: 20px;
            }
            
            .status-bar {
                right: 90px;
                font-size: 0.7rem;
            }
        }

        /* Mode-specific styles will be added dynamically */
    </style>
</head>
<body>
    <div class="version-indicator">
        <div>üåå KOZMIC MASTER STUDIO v3.0</div>
        <div id="currentMode">Mode: None</div>
    </div>

    <div class="master-header">
        <h1 class="master-title">üåå KOZMIC MASTER STUDIO üé∏</h1>
        <p style="font-size: 1.2rem; color: #4ecdc4;">Ultimate Edition - Three Studios in One</p>
        
        <div class="mode-selector">
            <button class="mode-btn" data-mode="portable" onclick="switchMode('portable')">
                üé∏ PORTABLE STUDIO
            </button>
            <button class="mode-btn" data-mode="live" onclick="switchMode('live')">
                üé§ LIVE CONSOLE
            </button>
            <button class="mode-btn" data-mode="complete" onclick="switchMode('complete')">
                üè† COMPLETE STUDIO
            </button>
        </div>

        <div class="mode-description" id="modeDescription">
            <strong>Welcome to the Kozmic Master Studio!</strong><br>
            Choose a mode above to begin your cosmic musical journey.<br>
            Each mode offers unique features for different creative needs.
        </div>
    </div>

    <div class="studio-container" id="studioContainer">
        <div class="loading-indicator" style="display: none;" id="loadingIndicator">
            <div class="loading-spinner"></div>
            <div>Loading Cosmic Frequencies...</div>
        </div>
    </div>

    <div class="status-bar">
        <span id="statusText">Ready to rock the cosmos! Select a studio mode.</span>
        <span id="statusTime">00:00</span>
    </div>

    <div class="cosmic-creature-master" id="cosmicCreatureMaster" onclick="pulseCreatureMaster()">üåå</div>

    <div class="easter-egg" id="easterEgg">
        <h2>üåü COSMIC HYPERNOVA ACTIVATED! üåü</h2>
        <p>You've unlocked the secret of universal harmony!</p>
        <button onclick="closeEasterEgg()" style="margin-top: 20px; padding: 10px 20px; background: #4ecdc4; border: none; border-radius: 10px; color: #000; font-weight: bold; cursor: pointer;">Continue Jamming</button>
    </div>

    <script>
        // Master Studio Core Variables
        let currentStudioMode = null;
        let sessionStartTime = Date.now();
        let creatureClicks = 0;
        let activeModules = {};
        let masterAudioContext = null;
        
        // Mode Descriptions
        const modeDescriptions = {
            portable: {
                title: "üé∏ Portable Studio Mode",
                description: "Mobile-friendly WebGL studio with cosmic visual effects, perfect for on-the-go jamming and quick recordings."
            },
            live: {
                title: "üé§ Live Console Mode", 
                description: "Professional live performance console with video integration, speech control, and real-time effects for stage use."
            },
            complete: {
                title: "üè† Complete Studio Mode",
                description: "Full-featured home studio with multitrack recording, world music genres, AI assistance, and professional mixing."
            }
        };

        // Shared Utility Functions
        function safeElement(id) {
            const el = document.getElementById(id);
            return el || { 
                textContent: '', 
                style: {}, 
                classList: { add: () => {}, remove: () => {}, toggle: () => {} },
                innerHTML: '',
                appendChild: () => {},
                removeChild: () => {}
            };
        }

        function updateStatus(message) {
            safeElement('statusText').textContent = message;
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            safeElement('statusTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Mode Switching System
        async function switchMode(mode) {
            try {
                updateStatus(`Switching to ${mode} mode...`);
                showLoading(true);
                
                // Clear current mode
                if (currentStudioMode) {
                    clearCurrentMode();
                }
                
                // Update UI
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
                
                // Update description
                const desc = modeDescriptions[mode];
                safeElement('modeDescription').innerHTML = `
                    <strong>${desc.title}</strong><br>
                    ${desc.description}
                `;
                
                safeElement('currentMode').textContent = `Mode: ${mode.toUpperCase()}`;
                
                // Load the selected mode
                await loadMode(mode);
                
                currentStudioMode = mode;
                showLoading(false);
                updateStatus(`${mode.toUpperCase()} mode active - Ready to rock!`);
                
                pulseCreatureMaster();
                
            } catch (error) {
                console.error('Mode switch error:', error);
                updateStatus('Error switching modes');
                showLoading(false);
            }
        }

        function showLoading(show) {
            safeElement('loadingIndicator').style.display = show ? 'block' : 'none';
        }

        function clearCurrentMode() {
            const container = safeElement('studioContainer');
            container.innerHTML = '';
            
            // Stop any audio contexts
            if (masterAudioContext) {
                masterAudioContext.close();
                masterAudioContext = null;
            }
            
            // Clear any intervals/timeouts
            activeModules = {};
        }

        // Mode Loading Functions
        async function loadMode(mode) {
            const container = safeElement('studioContainer');
            
            switch (mode) {
                case 'portable':
                    await loadPortableMode(container);
                    break;
                case 'live':
                    await loadLiveMode(container);
                    break;
                case 'complete':
                    await loadCompleteMode(container);
                    break;
                default:
                    throw new Error('Unknown mode: ' + mode);
            }
        }

        // Portable Studio Mode
        async function loadPortableMode(container) {
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr; gap: 20px;">
                    <div style="position: relative; width: 100%; height: 50vh; min-height: 300px; background: linear-gradient(45deg, #2c2c4e, #1a1a2e); border: 3px solid #ff6b9d; border-radius: 20px; overflow: hidden;">
                        <canvas id="kozmicCanvas"></canvas>
                        <div style="position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.8); border: 2px solid #4ecdc4; border-radius: 12px; padding: 8px 12px; font-size: 0.8rem; color: #4ecdc4;">
                            <span id="portableStatus">READY</span>
                        </div>
                        <div style="position: absolute; bottom: 15px; left: 15px; right: 15px; height: 8px; background: rgba(0,0,0,0.5); border-radius: 4px; overflow: hidden; border: 1px solid #4ecdc4;">
                            <div id="portablePowerBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #4ecdc4, #ff6b9d, #ffd93d); transition: width 0.1s ease; border-radius: 3px;"></div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                        <div style="background: rgba(44, 44, 78, 0.9); border: 2px solid #ff6b9d; border-radius: 15px; padding: 20px;">
                            <h3 style="color: #ff6b9d; text-align: center; margin-bottom: 15px;">üéµ AUDIO INPUT</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                <button class="kozmic-btn" onclick="connectPortableAudio()">CONNECT</button>
                                <button class="kozmic-btn" onclick="togglePortableRecord()">RECORD</button>
                                <button class="kozmic-btn" onclick="togglePortableTuner()">TUNER</button>
                                <button class="kozmic-btn" onclick="togglePortableAmplify()">AMPLIFY</button>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 3px; height: 60px; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 5px;">
                                <div class="freq-bar" style="background: linear-gradient(to top, #4ecdc4, #ff6b9d, #ffd93d); border-radius: 3px; transition: height 0.1s ease; min-height: 2px;"></div>
                                <div class="freq-bar" style="background: linear-gradient(to top, #4ecdc4, #ff6b9d, #ffd93d); border-radius: 3px; transition: height 0.1s ease; min-height: 2px;"></div>
                                <div class="freq-bar" style="background: linear-gradient(to top, #4ecdc4, #ff6b9d, #ffd93d); border-radius: 3px; transition: height 0.1s ease; min-height: 2px;"></div>
                                <div class="freq-bar" style="background: linear-gradient(to top, #4ecdc4, #ff6b9d, #ffd93d); border-radius: 3px; transition: height 0.1s ease; min-height: 2px;"></div>
                                <div class="freq-bar" style="background: linear-gradient(to top, #4ecdc4, #ff6b9d, #ffd93d); border-radius: 3px; transition: height 0.1s ease; min-height: 2px;"></div>
                                <div class="freq-bar" style="background: linear-gradient(to top, #4ecdc4, #ff6b9d, #ffd93d); border-radius: 3px; transition: height 0.1s ease; min-height: 2px;"></div>
                                <div class="freq-bar" style="background: linear-gradient(to top, #4ecdc4, #ff6b9d, #ffd93d); border-radius: 3px; transition: height 0.1s ease; min-height: 2px;"></div>
                                <div class="freq-bar" style="background: linear-gradient(to top, #4ecdc4, #ff6b9d, #ffd93d); border-radius: 3px; transition: height 0.1s ease; min-height: 2px;"></div>
                            </div>
                        </div>
                        
                        <div style="background: rgba(44, 44, 78, 0.9); border: 2px solid #ff6b9d; border-radius: 15px; padding: 20px;">
                            <h3 style="color: #ff6b9d; text-align: center; margin-bottom: 15px;">üåÄ COSMIC EFFECTS</h3>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: 10px 0;">
                                <button class="effect-btn active" data-effect="particles" onclick="setPortableEffect('particles')">PARTICLES</button>
                                <button class="effect-btn" data-effect="nebula" onclick="setPortableEffect('nebula')">NEBULA</button>
                                <button class="effect-btn" data-effect="waveform" onclick="setPortableEffect('waveform')">WAVEFORM</button>
                                <button class="effect-btn" data-effect="cosmic" onclick="setPortableEffect('cosmic')">COSMIC</button>
                                <button class="effect-btn" data-effect="spiral" onclick="setPortableEffect('spiral')">SPIRAL</button>
                                <button class="effect-btn" data-effect="burst" onclick="setPortableEffect('burst')">BURST</button>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <button class="kozmic-btn" onclick="togglePortableEffects()">EFFECTS ON</button>
                                <button class="kozmic-btn" onclick="adjustPortableIntensity()">INTENSITY</button>
                            </div>
                        </div>
                        
                        <div style="background: rgba(44, 44, 78, 0.9); border: 2px solid #ff6b9d; border-radius: 15px; padding: 20px;">
                            <h3 style="color: #ff6b9d; text-align: center; margin-bottom: 15px;">üíæ SESSION CONTROL</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <button class="kozmic-btn" onclick="savePortableSession()">SAVE</button>
                                <button class="kozmic-btn" onclick="loadPortableSession()">LOAD</button>
                                <button class="kozmic-btn" onclick="exportPortableRecording()">EXPORT</button>
                                <button class="kozmic-btn" onclick="resetPortableSession()">RESET</button>
                            </div>
                            <div id="portableSessionInfo" style="margin-top: 10px; padding: 8px; background: rgba(0,0,0,0.4); border-radius: 8px; font-size: 0.8rem;">
                                Session: Ready<br>
                                Effect: PARTICLES<br>
                                Mode: PORTABLE
                            </div>
                        </div>
                    </div>
                </div>
                
                <style>
                    .kozmic-btn {
                        background: linear-gradient(45deg, #ff6b9d, #4ecdc4);
                        border: none;
                        padding: 12px 8px;
                        border-radius: 12px;
                        color: white;
                        font-weight: bold;
                        font-family: 'Courier New', monospace;
                        font-size: 0.9rem;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    }
                    .kozmic-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 107, 157, 0.4); }
                    .kozmic-btn.active { background: linear-gradient(45deg, #ffd93d, #ff6b9d); }
                    .effect-btn {
                        padding: 8px 4px;
                        font-size: 0.8rem;
                        background: rgba(0, 0, 0, 0.3);
                        border: 1px solid #4ecdc4;
                        color: #4ecdc4;
                        border-radius: 8px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    }
                    .effect-btn:hover { background: rgba(78, 205, 196, 0.2); border-color: #ff6b9d; color: #ff6b9d; }
                    .effect-btn.active { background: #4ecdc4; color: #000; }
                </style>
            `;
            
            // Initialize WebGL for portable mode
            initPortableWebGL();
            
            updateStatus('Portable Studio loaded - Perfect for mobile jamming!');
        }

        // Live Console Mode
        async function loadLiveMode(container) {
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                    <div style="background: rgba(255, 107, 157, 0.15); border: 2px solid #ff6b9d; border-radius: 15px; padding: 20px;">
                        <h2 style="color: #ff6b9d; margin-bottom: 15px; text-align: center;">üé∏ Guitar & Video Input</h2>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <button class="live-btn" onclick="connectLiveGuitar()">Connect Guitar</button>
                            <button class="live-btn" onclick="toggleLiveSpeech()">Speech Control üé§</button>
                            <button class="live-btn" onclick="toggleLiveAudioRecord()">Record Audio üéô</button>
                            <button class="live-btn" onclick="toggleLiveVideoRecord()">Record Video üé•</button>
                            
                            <div style="width: 100%; height: 120px; background: linear-gradient(90deg, #1a1a2e, #0f3460); border-radius: 10px; position: relative; overflow: hidden;">
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #fff; font-size: 14px;">
                                    üé∏ Guitar Visualization Ready<br><small>Connect webcam for video</small>
                                </div>
                                <div class="guitar-string" style="position: absolute; width: 100%; height: 2px; background: #c0c0c0; top: 10px;"></div>
                                <div class="guitar-string" style="position: absolute; width: 100%; height: 2px; background: #c0c0c0; top: 30px;"></div>
                                <div class="guitar-string" style="position: absolute; width: 100%; height: 2px; background: #c0c0c0; top: 50px;"></div>
                                <div class="guitar-string" style="position: absolute; width: 100%; height: 2px; background: #c0c0c0; top: 70px;"></div>
                                <div class="guitar-string" style="position: absolute; width: 100%; height: 2px; background: #c0c0c0; top: 90px;"></div>
                                <div class="guitar-string" style="position: absolute; width: 100%; height: 2px; background: #c0c0c0; top: 110px;"></div>
                            </div>
                            
                            <div style="width: 100%; height: 30px; background: #2c2c4e; border-radius: 15px; overflow: hidden; position: relative;">
                                <div id="liveVolumeBar" style="height: 100%; background: linear-gradient(90deg, #00ff00, #ffff00, #ff0000); width: 0%; transition: width 0.1s ease;"></div>
                            </div>
                            
                            <div id="liveStatus" style="background: rgba(0, 0, 0, 0.5); padding: 10px; border-radius: 10px; font-family: monospace; font-size: 12px; min-height: 60px;">
                                Ready for your 2 guitars...<br>
                                Click "Connect Guitar" to start!
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255, 107, 157, 0.15); border: 2px solid #ff6b9d; border-radius: 15px; padding: 20px;">
                        <h2 style="color: #ff6b9d; margin-bottom: 15px; text-align: center;">üåü Genre Selector</h2>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                            <button class="live-btn motown-style" onclick="applyLiveGenre('motown')" style="background: linear-gradient(45deg, #d4af37, #ffd700); color: #000;">üéµ Motown</button>
                            <button class="live-btn" onclick="applyLiveGenre('blues')" style="background: linear-gradient(45deg, #1e3c72, #2a5298);">üé∏ Blues</button>
                            <button class="live-btn" onclick="applyLiveGenre('jazz')" style="background: linear-gradient(45deg, #8b4513, #daa520);">üé∑ Jazz</button>
                            <button class="live-btn" onclick="applyLiveGenre('rock')" style="background: linear-gradient(45deg, #ff4500, #ff6347);">ü§ò Rock</button>
                            <button class="live-btn" onclick="applyLiveGenre('funk')" style="background: linear-gradient(45deg, #800080, #ff1493);">üé∫ Funk</button>
                            <button class="live-btn" onclick="applyLiveGenre('psychedelic')" style="background: linear-gradient(45deg, #ff69b4, #9370db);">üåà Psychedelic</button>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <h3 style="color: #4ecdc4; margin-bottom: 10px;">üéõÔ∏è Effects Rack</h3>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                <div style="text-align: center;">
                                    <label style="font-size: 0.8rem;">Slide</label>
                                    <div class="effect-knob" data-effect="slide" onclick="adjustLiveEffect('slide')" style="width: 50px; height: 50px; background: radial-gradient(circle, #333, #666); border-radius: 50%; position: relative; cursor: pointer; margin: 5px auto;">
                                        <div style="position: absolute; top: 3px; left: 50%; width: 2px; height: 15px; background: #ff6b9d; transform: translateX(-50%); border-radius: 1px;"></div>
                                    </div>
                                </div>
                                <div style="text-align: center;">
                                    <label style="font-size: 0.8rem;">Drive</label>
                                    <div class="effect-knob" data-effect="drive" onclick="adjustLiveEffect('drive')" style="width: 50px; height: 50px; background: radial-gradient(circle, #333, #666); border-radius: 50%; position: relative; cursor: pointer; margin: 5px auto;">
                                        <div style="position: absolute; top: 3px; left: 50%; width: 2px; height: 15px; background: #ff6b9d; transform: translateX(-50%); border-radius: 1px;"></div>
                                    </div>
                                </div>
                                <div style="text-align: center;">
                                    <label style="font-size: 0.8rem;">Reverb</label>
                                    <div class="effect-knob" data-effect="reverb" onclick="adjustLiveEffect('reverb')" style="width: 50px; height: 50px; background: radial-gradient(circle, #333, #666); border-radius: 50%; position: relative; cursor: pointer; margin: 5px auto;">
                                        <div style="position: absolute; top: 3px; left: 50%; width: 2px; height: 15px; background: #ff6b9d; transform: translateX(-50%); border-radius: 1px;"></div>
                                    </div>
                                </div>
                                <div style="text-align: center;">
                                    <label style="font-size: 0.8rem;">Delay</label>
                                    <div class="effect-knob" data-effect="delay" onclick="adjustLiveEffect('delay')" style="width: 50px; height: 50px; background: radial-gradient(circle, #333, #666); border-radius: 50%; position: relative; cursor: pointer; margin: 5px auto;">
                                        <div style="position: absolute; top: 3px; left: 50%; width: 2px; height: 15px; background: #ff6b9d; transform: translateX(-50%); border-radius: 1px;"></div>
                                    </div>
                                </div>
                                <div style="text-align: center;">
                                    <label style="font-size: 0.8rem;">Wah</label>
                                    <div class="effect-knob" data-effect="wah" onclick="adjustLiveEffect('wah')" style="width: 50px; height: 50px; background: radial-gradient(circle, #333, #666); border-radius: 50%; position: relative; cursor: pointer; margin: 5px auto;">
                                        <div style="position: absolute; top: 3px; left: 50%; width: 2px; height: 15px; background: #ff6b9d; transform: translateX(-50%); border-radius: 1px;"></div>
                                    </div>
                                </div>
                                <div style="text-align: center;">
                                    <label style="font-size: 0.8rem;">Chorus</label>
                                    <div class="effect-knob" data-effect="chorus" onclick="adjustLiveEffect('chorus')" style="width: 50px; height: 50px; background: radial-gradient(circle, #333, #666); border-radius: 50%; position: relative; cursor: pointer; margin: 5px auto;">
                                        <div style="position: absolute; top: 3px; left: 50%; width: 2px; height: 15px; background: #ff6b9d; transform: translateX(-50%); border-radius: 1px;"></div>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <button class="live-btn" onclick="killLiveEffects()">üîá Kill Effects</button>
                                <button class="live-btn" onclick="randomLiveEffects()">üé≤ Random</button>
                            </div>
                        </div>
                    </div>
